<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: transparent; }
        /* High height to ensure Tranzila fields aren't cut off */
        #tranzila-frame { width: 100%; height: 600px; border: none; }
    </style>
</head>
<body>

    <form id="tranzila-form" action="https://direct.tranzila.com/toratshraga/iframenew.php" method="POST" target="tranzila-frame">
        <input type="hidden" name="sum" value="1"> 
        <input type="hidden" name="currency" value="1"> 
        <input type="hidden" name="tranmode" value="VK">
        <input type="hidden" name="contact" value="Student Registration">
        <input type="hidden" name="nologo" value="1">
        <input type="hidden" name="hidesum" value="1">
    </form>

    <iframe name="tranzila-frame" id="tranzila-frame" allow="payment"></iframe>

    <script>
        // Start Tranzila
        window.onload = function() {
            document.getElementById('tranzila-form').submit();
        };

        // Listen for the response
        window.addEventListener("message", function(event) {
            var data = event.data;

            // Fix for the "[object Object] is not valid JSON" error
            // If it's already an object, we use it directly. 
            // If it's a string, we try to parse it safely.
            var payload;
            if (typeof data === 'object' && data !== null) {
                payload = data;
            } else if (typeof data === 'string') {
                try {
                    payload = JSON.parse(data);
                } catch (e) {
                    return; // Ignore non-JSON messages
                }
            }

            if (payload && (payload.TranzilaTK || payload.temp_token)) {
                var token = payload.TranzilaTK || payload.temp_token;
                
                // Send the token back to your Jotform submission
                JFCustomWidget.sendData({ value: token });
                JFCustomWidget.sendSubmit({ valid: true });
            }
        }, false);
    </script>
</body>
</html>
