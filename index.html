<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

    <div id="setup-view">
        <p>Click below to securely provide card details for registration.</p>
        <button class="btn" onclick="openTranzila()">Add Credit Card</button>
    </div>

    <script>
        function openTranzila() {
            // This URL opens Tranzila's own secure page directly
            var tranzilaUrl = "https://direct.tranzila.com/toratshraga/iframenew.php?" + 
                "sum=1&currency=1&tranmode=VK&contact=Student&nologo=1&hidesum=1";
            
            // Open it in a popup so it doesn't clash with Jotform's scripts
            var width = 500;
            var height = 600;
            var left = (window.innerWidth / 2) - (width / 2);
            var top = (window.innerHeight / 2) - (height / 2);
            
            window.open(tranzilaUrl, "Tranzila", "width="+width+",height="+height+",top="+top+",left="+left);
        }

        // Listen for the Token coming back
        window.addEventListener("message", function(event) {
            // Tranzila usually sends the data back to the 'opener' window
            var data = event.data;
            
            // Handle both String and Object responses
            if (typeof data === 'string') {
                try { data = JSON.parse(data); } catch(e) {}
            }

            if (data && data.TranzilaTK) {
                // Success! Save to Jotform
                JFCustomWidget.sendData({ value: data.TranzilaTK });
                
                // Update UI to show it worked
                document.getElementById('setup-view').innerHTML = "<b>âœ… Card Linked Successfully</b>";
                
                // Allow Jotform to submit
                JFCustomWidget.sendSubmit({ valid: true });
            }
        }, false);
    </script>
</body>
</html>
